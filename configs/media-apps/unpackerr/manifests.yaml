---
# ConfigMap for Unpackerr settings
apiVersion: v1
kind: ConfigMap
metadata:
  name: unpackerr-config
  namespace: media
data:
  unpackerr.conf: |
    [unpackerr]
    interval = "1m"
    start_delay = "5m"

    [paths]
    # This path is relative to the *container* mount.
    # Since we mount 'media-root-pvc' to /media, this is the correct path.
    downloads = "/media/downloads"

    [qbit]
    # URL to your qBittorrent VM
    url = "http://YOUR_VM_IP:8080"

    [folders]
    # These are sub-folders *inside* your downloads path
    tv = "tv"
    movies = "movies"
    music = "music"
---
# Deployment for Unpackerr
apiVersion: apps/v1
kind: Deployment
metadata:
  name: unpackerr
  namespace: media
  labels:
    app: unpackerr
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: unpackerr
  template:
    metadata:
      labels:
        app: unpackerr
    spec:
      containers:
        - name: unpackerr
          image: ghcr.io/unpackerr/unpackerr:latest
          securityContext:
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          env:
            - name: TZ
              value: "Africa/Lagos"
            - name: UN_CONFIG_FILE
              value: "/config/unpackerr.conf"

            # Injecting credentials securely from the secret
            - name: UN_QBIT_USER
              valueFrom:
                secretKeyRef:
                  name: qbit-creds
                  key: username
            - name: UN_QBIT_PASS
              valueFrom:
                secretKeyRef:
                  name: qbit-creds
                  key: password
          ports:
            - containerPort: 5656
              name: http
          volumeMounts:
            # Mount the config file
            - name: config
              mountPath: /config
              readOnly: true
            # CORRECTED: Mount the main media PVC
            - name: media
              mountPath: /media
            # Required for read-only root
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: config
          configMap:
            name: unpackerr-config
        # CORRECTED: Use the same PVC as Sonarr/Radarr
        - name: media
          persistentVolumeClaim:
            claimName: media-root-pvc
        - name: tmp
          emptyDir: {}
