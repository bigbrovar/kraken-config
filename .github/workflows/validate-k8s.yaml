---
name: Validate Kubernetes Manifests
'on':
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # CHECK 1: YAML Syntax
      - name: Set up yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: yamllint .

      # CHECK 2: Kubernetes Schema Validation
      - name: Set up kubeconform
        run: |
          # Break long line by using a variable
          KUBEFORM_URL="https://github.com/yannh/kubeconform/releases/download"
          KUBEFORM_URL="${KUBEFORM_URL}/v0.6.6/kubeconform-linux-amd64.tar.gz"
          curl -Lo kubeconform.tar.gz "$KUBEFORM_URL"
          tar xf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Download CRD Schemas
        run: |
          mkdir -p /tmp/crds

          echo "Downloading cert-manager CRDs..."
          CERTMGR_URL="https://github.com/cert-manager/cert-manager"
          CERTMGR_URL="${CERTMGR_URL}/releases/download/v1.16.2"
          curl -sSL "${CERTMGR_URL}/cert-manager.crds.yaml" \
            -o /tmp/crds/cert-manager.yaml

          echo "Downloading sealed-secrets CRDs..."
          SEALED_URL="https://raw.githubusercontent.com"
          SEALED_URL="${SEALED_URL}/bitnami-labs/sealed-secrets"
          SEALED_URL="${SEALED_URL}/v0.27.2/helm/sealed-secrets/crds"
          curl -sSL "${SEALED_URL}/bitnami.com_sealedsecrets.yaml" \
            -o /tmp/crds/sealed-secrets.yaml

          echo "CRD schemas downloaded"
          ls -lh /tmp/crds/

      - name: Run kubeconform
        run: |
          # Run kubeconform with CRD schemas
          kubeconform -summary -kubernetes-version 1.30.2 \
            -schema-location default \
            -schema-location '/tmp/crds/{{.ResourceKind}}.yaml' \
            -skip Application \
            -ignore-filename-pattern '.github/.*' \
            .

      # CHECK 3: Security Scan
      - name: Set up Trivy
        run: |
          # Break long lines by using variables
          TRIVY_REPO="https://raw.githubusercontent.com"
          TRIVY_REPO="${TRIVY_REPO}/aquasecurity/trivy/main"
          TRIVY_INSTALL_SCRIPT="${TRIVY_REPO}/contrib/install.sh"
          curl -sfL "${TRIVY_INSTALL_SCRIPT}" | sh -s -- -b /usr/local/bin

      - name: Run Trivy
        run: |
          # Break long command onto new lines
          trivy config \
            --exit-code 1 \
            --severity HIGH,CRITICAL \
            .
