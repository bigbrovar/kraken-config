---
name: Validate Kubernetes Manifests
'on':
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      # CHECK 1: YAML Syntax
      - name: Set up yamllint
        run: pip install yamllint
      - name: Run yamllint
        run: yamllint .
      # CHECK 2: Kubernetes Schema Validation
      - name: Set up kubeconform
        run: |
          # Break long line by using a variable
          KUBEFORM_URL="https://github.com/yannh/kubeconform/releases/download"
          KUBEFORM_URL="${KUBEFORM_URL}/v0.6.6/kubeconform-linux-amd64.tar.gz"
          curl -Lo kubeconform.tar.gz "$KUBEFORM_URL"
          tar xf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/
      - name: Run kubeconform with CRD schemas
        run: |
          # Define schema URLs as variables to keep lines under 120 chars
          DATREE_SCHEMA="https://raw.githubusercontent.com"
          DATREE_SCHEMA="${DATREE_SCHEMA}/datreeio/CRDs-catalog/main"
          DATREE_SCHEMA="${DATREE_SCHEMA}/{{.Group}}"
          DATREE_SCHEMA="${DATREE_SCHEMA}/{{.ResourceKind}}"
          DATREE_SCHEMA="${DATREE_SCHEMA}_{{.ResourceAPIVersion}}.json"

          CERTMGR_SCHEMA="https://raw.githubusercontent.com"
          CERTMGR_SCHEMA="${CERTMGR_SCHEMA}/cert-manager/cert-manager"
          CERTMGR_SCHEMA="${CERTMGR_SCHEMA}/master/deploy/crds"
          CERTMGR_SCHEMA="${CERTMGR_SCHEMA}/{{.ResourceKind}}"
          CERTMGR_SCHEMA="${CERTMGR_SCHEMA}_{{.ResourceAPIVersion}}.json"

          SEALED_SCHEMA="https://raw.githubusercontent.com"
          SEALED_SCHEMA="${SEALED_SCHEMA}/bitnami-labs/sealed-secrets"
          SEALED_SCHEMA="${SEALED_SCHEMA}/main/helm/sealed-secrets/crds"
          SEALED_SCHEMA="${SEALED_SCHEMA}/{{.ResourceKind}}"
          SEALED_SCHEMA="${SEALED_SCHEMA}_{{.ResourceAPIVersion}}.json"

          kubeconform \
            -strict \
            -summary \
            -output json \
            -schema-location default \
            -schema-location "${DATREE_SCHEMA}" \
            -schema-location "${CERTMGR_SCHEMA}" \
            -schema-location "${SEALED_SCHEMA}" \
            configs/
      # CHECK 3: Security Scan
      - name: Set up Trivy
        run: |
          # Break long lines by using variables
          TRIVY_REPO="https://raw.githubusercontent.com"
          TRIVY_REPO="${TRIVY_REPO}/aquasecurity/trivy/main"
          TRIVY_INSTALL_SCRIPT="${TRIVY_REPO}/contrib/install.sh"
          curl -sfL "${TRIVY_INSTALL_SCRIPT}" | sh -s -- -b /usr/local/bin
      - name: Run Trivy
        run: |
          # Break long command onto new lines
          trivy config \
            --exit-code 1 \
            --severity HIGH,CRITICAL \
            .
